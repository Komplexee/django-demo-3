{% extends 'shop/base.html' %}
{% load shop_tags %}

{% block title %}Список товаров{% endblock %}

{% block content %}
    <h1>Список товаров</h1>

    {% if user.is_authenticated and user.profile.role in 'admin,manager' %}
    <div class="card mb-4">
        <div class="card-body">
            <form method="get">
                <div class="row">
                    <div class="col-md-3">
                        {{ filter.form.name.label_tag }}
                        {{ filter.form.name }}
                    </div>
                    <div class="col-md-3">
                        {{ filter.form.description.label_tag }}
                        {{ filter.form.description }}
                    </div>
                    <div class="col-md-2">
                        {{ filter.form.category__name.label_tag }}
                        {{ filter.form.category__name }}
                    </div>
                    <div class="col-md-2">
                        {{ filter.form.manufacturer__name.label_tag }}
                        {{ filter.form.manufacturer__name }}
                    </div>
                    <div class="col-md-2">
                        {{ filter.form.supplier__name.label_tag }}
                        {{ filter.form.supplier__name }}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <label for="sort">Сортировать по:</label>
                        <select name="sort" id="sort" class="form-control">
                            <option value="">--</option>
                            <option value="stock">Количеству на складе (возр)</option>
                            <option value="-stock">Количеству на складе (убыв)</option>
                            <option value="price">Цене (возр)</option>
                            <option value="-price">Цене (убыв)</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Применить</button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="row">
        {% for product in products %}
            <div class="col-md-4 mb-4">
                <div class="card" 
                    style="
                        {% if product.discount > 15 %}background-color: #2E8B57;{% endif %}
                        {% if product.stock == 0 %}background-color: #ADD8E6;{% endif %}
                    "
                >
                    <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text">{{ product.description }}</p>
                        <p>Категория: {{ product.category.name }}</p>
                        <p>Производитель: {{ product.manufacturer.name }}</p>
                        <p>Поставщик: {{ product.supplier.name }}</p>
                        {% if product.discount > 0 %}
                            <p>Цена: <span style="text-decoration: line-through; color: red;">{{ product.price }}</span> {{ product.price|discounted_price:product.discount }}</p>
                        {% else %}
                            <p>Цена: {{ product.price }}</p>
                        {% endif %}
                        <p>Единица измерения: {{ product.unit }}</p>
                        <p>Количество на складе: {{ product.stock }}</p>
                        
                        {% if user.is_authenticated and user.profile.role == 'admin' %}
                        <a href="{% url 'product_update' product.pk %}" class="btn btn-primary">Редактировать</a>
                        <a href="{% url 'product_delete' product.pk %}" class="btn btn-danger">Удалить</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}
